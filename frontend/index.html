<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>HomePi Dashboard</title>
  <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/iiiypuk/rpi-icon/master/256.png" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #e5e7eb;
    }
    body {
      margin: 0;
      padding: 1.5rem;
    }
    .container {
      max-width: 1100px;
      margin: 0 auto;
    }
    h1 {
      font-size: 1.8rem;
      margin-bottom: 0.5rem;
    }
    .subtitle {
      color: #64748b;
      margin-bottom: 1.5rem;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .card {
      background: #020617;
      border-radius: 0.75rem;
      padding: 1rem 1.2rem;
      border: 1px solid #1f2937;
      box-shadow: 0 10px 20px rgba(0,0,0,0.35);
    }
    .card h2 {
      font-size: 1.1rem;
      margin: 0 0 0.8rem 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .badge {
      padding: 0.1rem 0.5rem;
      border-radius: 999px;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .badge.ok {
      background: rgba(34, 197, 94, 0.15);
      border: 1px solid rgba(34, 197, 94, 0.4);
      color: #4ade80;
    }
    .badge.warn {
      background: rgba(234, 179, 8, 0.15);
      border: 1px solid rgba(234, 179, 8, 0.4);
      color: #facc15;
    }
    .badge.crit, .badge.offline {
      background: rgba(239, 68, 68, 0.15);
      border: 1px solid rgba(239, 68, 68, 0.4);
      color: #f97373;
    }
    .badge.offline {
      text-transform: none;
    }
    .metric {
      display: flex;
      justify-content: space-between;
      font-size: 0.9rem;
      margin-bottom: 0.3rem;
    }
    .metric span.value {
      font-variant-numeric: tabular-nums;
      color: #e5e7eb;
    }
    .metric span.label {
      color: #9ca
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>HomePi Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #e5e7eb;
    }
    body {
      margin: 0;
      padding: 1.5rem;
    }
    .container {
      max-width: 1100px;
      margin: 0 auto;
    }
    h1 {
      font-size: 1.8rem;
      margin-bottom: 0.5rem;
    }
    .subtitle {
      color: #64748b;
      margin-bottom: 1.5rem;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .card {
      background: #020617;
      border-radius: 0.75rem;
      padding: 1rem 1.2rem;
      border: 1px solid #1f2937;
      box-shadow: 0 10px 20px rgba(0,0,0,0.35);
    }
    .card h2 {
      font-size: 1.1rem;
      margin: 0 0 0.8rem 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .badge {
      padding: 0.1rem 0.5rem;
      border-radius: 999px;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .badge.ok {
      background: rgba(34, 197, 94, 0.15);
      border: 1px solid rgba(34, 197, 94, 0.4);
      color: #4ade80;
    }
    .badge.warn {
      background: rgba(234, 179, 8, 0.15);
      border: 1px solid rgba(234, 179, 8, 0.4);
      color: #facc15;
    }
    .badge.crit, .badge.offline {
      background: rgba(239, 68, 68, 0.15);
      border: 1px solid rgba(239, 68, 68, 0.4);
      color: #f97373;
    }
    .badge.offline {
      text-transform: none;
    }
    .metric {
      display: flex;
      justify-content: space-between;
      font-size: 0.9rem;
      margin-bottom: 0.3rem;
    }
    .metric span.value {
      font-variant-numeric: tabular-nums;
      color: #e5e7eb;
    }
    .metric span.label {
      color: #9ca3af;
    }
    .progress {
      width: 100%;
      height: 6px;
      border-radius: 999px;
      background: #111827;
      overflow: hidden;
      margin-top: 0.3rem;
      margin-bottom: 0.4rem;
    }
    .progress-inner {
      height: 100%;
      width: 0%;
      border-radius: 999px;
      background: linear-gradient(90deg, #22c55e, #eab308, #ef4444);
      transition: width 0.3s ease;
    }
    .section-title {
      margin: 1.5rem 0 0.8rem;
      font-size: 1.1rem;
      color: #e5e7eb;
    }
    .actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-top: 0.5rem;
    }
    button {
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: #020617;
      padding: 0.35rem 0.9rem;
      font-size: 0.85rem;
      cursor: pointer;
      color: #e5e7eb;
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      transition: background 0.15s ease, transform 0.05s ease, border-color 0.15s ease;
    }
    button:hover {
      background: #0f172a;
      border-color: #334155;
      transform: translateY(-1px);
    }
    button:disabled {
      opacity: 0.4;
      cursor: default;
      transform: none;
    }
    button.primary {
      border-color: #22c55e;
    }
    button.danger {
      border-color: #ef4444;
    }
    .text-muted {
      color: #6b7280;
      font-size: 0.85rem;
    }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      background: #020617;
      border: 1px solid #1f2937;
      font-size: 0.75rem;
      color: #9ca3af;
    }
    .pill-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #dc2626;
    }
    .pill-dot.online {
      background: #22c55e;
    }
    .footer {
      margin-top: 1.5rem;
      font-size: 0.75rem;
      color: #4b5563;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>HomePi Dashboard</h1>
    <div class="subtitle">System & Minecraft overview – refreshed every 5 seconds.</div>

    <div class="section-title">System</div>
    <div class="grid">
      <div class="card">
        <h2>
          CPU
          <span id="cpu-temp-badge" class="badge">...</span>
        </h2>
        <div class="metric">
          <span class="label">Temperature</span>
          <span id="cpu-temp-value" class="value">–</span>
        </div>
        <div class="metric">
          <span class="label">Usage</span>
          <span id="cpu-usage-value" class="value">–</span>
        </div>
        <div class="progress">
          <div id="cpu-usage-bar" class="progress-inner"></div>
        </div>
        <div class="text-muted" id="cpu-temp-range"></div>
      </div>

      <div class="card">
        <h2>Memory</h2>
        <div class="metric">
          <span class="label">RAM used</span>
          <span id="ram-used" class="value">–</span>
        </div>
        <div class="progress">
          <div id="ram-usage-bar" class="progress-inner"></div>
        </div>
        <div class="metric">
          <span class="label">Disk used</span>
          <span id="disk-used" class="value">–</span>
        </div>
        <div class="progress">
          <div id="disk-usage-bar" class="progress-inner"></div>
        </div>
        <div class="text-muted" id="disk-free"></div>
      </div>
    </div>

    <div class="section-title">Minecraft</div>
    <div class="grid">
      <div class="card">
        <h2>
          Status
          <span id="mc-online-pill" class="pill">
            <span class="pill-dot" id="mc-online-dot"></span>
            <span id="mc-online-text">Unknown</span>
          </span>
        </h2>
        <div class="metric">
          <span class="label">Process</span>
          <span id="mc-process-state" class="value">–</span>
        </div>
        <div class="metric">
          <span class="label">Players</span>
          <span id="mc-players" class="value">–</span>
        </div>
        <div class="metric">
          <span class="label">Version</span>
          <span id="mc-version" class="value">–</span>
        </div>
        <div class="metric">
          <span class="label">Latency</span>
          <span id="mc-latency" class="value">–</span>
        </div>
      </div>

      <div class="card">
        <h2>
          Activity
          <span id="mc-mood-badge" class="badge">...</span>
        </h2>
        <div class="metric">
          <span class="label">CPU</span>
          <span id="mc-cpu" class="value">–</span>
        </div>
        <div class="progress">
          <div id="mc-cpu-bar" class="progress-inner"></div>
        </div>
        <div class="metric">
          <span class="label">RAM used</span>
          <span id="mc-ram" class="value">–</span>
        </div>
        <div class="progress">
          <div id="mc-ram-bar" class="progress-inner"></div>
        </div>
        <div class="text-muted" id="mc-activity-extra"></div>

        <div class="actions">
          <button style="cursor: pointer;" id="btn-start" class="primary">Start</button>
          <button style="cursor: pointer;" id="btn-restart">Restart</button>
          <button style="cursor: pointer;" id="btn-stop" class="danger">Stop</button>
        </div>
        <div class="text-muted" id="mc-action-status"></div>
      </div>
    </div>

    <div class="section-title">Minecraft Logs</div>
    <div
      class="card"
      id="mc-logs-card"
      style="max-height: 320px; overflow-y: auto; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size: 0.8rem; white-space: pre-wrap;"
    >
      <div id="mc-logs">Loading logs...</div>
    </div>

    <div class="footer">
    </div>
  </div>

  <script>
    const systemUrl = "/api/system";
    const mcStatusUrl = "/api/minecraft/status";
    const mcActivityUrl = "/api/minecraft/activity";
    const mcLogsUrl = "/api/minecraft/logs?lines=200";


    function setBar(elementId, percent) {
      const el = document.getElementById(elementId);
      if (!el) return;
      const v = Math.max(0, Math.min(100, percent || 0));
      el.style.width = v + "%";
    }

    function formatGB(value) {
      return typeof value === "number" ? value.toFixed(2) + " GB" : "–";
    }

    async function refreshSystem() {
      try {
        const res = await fetch(systemUrl);
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();

        const cpuTemp = data.cpu.temperature;
        const cpuUsage = data.cpu.usage;
        const ram = data.memory.ram;
        const disk = data.memory.disk;

        // CPU temp badge
        const badge = document.getElementById("cpu-temp-badge");
        const tempValEl = document.getElementById("cpu-temp-value");
        const tempRangeEl = document.getElementById("cpu-temp-range");

        if (cpuTemp && cpuTemp.values.current != null) {
          const current = cpuTemp.values.current;
          tempValEl.textContent = current + " °C";
          tempRangeEl.textContent = `High: ${cpuTemp.values.high} °C · Critical: ${cpuTemp.values.critical} °C`;

          badge.textContent = cpuTemp.status;
          badge.className = "badge";
          if (cpuTemp.status === "normal") badge.classList.add("ok");
          else if (cpuTemp.status === "warning") badge.classList.add("warn");
          else if (cpuTemp.status === "critical") badge.classList.add("crit");
        } else {
          tempValEl.textContent = "unknown";
          tempRangeEl.textContent = "";
          badge.textContent = "unknown";
          badge.className = "badge";
        }

        // CPU usage
        document.getElementById("cpu-usage-value").textContent =
          (cpuUsage != null ? cpuUsage.toFixed(1) : "–") + " %";
        setBar("cpu-usage-bar", cpuUsage || 0);

        // RAM
        document.getElementById("ram-used").textContent =
          `${formatGB(ram.used_gb)} / ${formatGB(ram.total_gb)} (${ram.percent.toFixed(1)}%)`;
        setBar("ram-usage-bar", ram.percent || 0);

        // Disk
        document.getElementById("disk-used").textContent =
          `${formatGB(disk.used_gb)} / ${formatGB(disk.total_gb)} (${disk.percent.toFixed(1)}%)`;
        document.getElementById("disk-free").textContent =
          `Free: ${formatGB(disk.free_gb)}`;
        setBar("disk-usage-bar", disk.percent || 0);
      } catch (e) {
        console.error("Error fetching system info", e);
      }
    }

    async function refreshMinecraft() {
      try {
        const [statusRes, activityRes] = await Promise.all([
          fetch(mcStatusUrl),
          fetch(mcActivityUrl),
        ]);

        if (!statusRes.ok) throw new Error("status HTTP " + statusRes.status);
        if (!activityRes.ok) throw new Error("activity HTTP " + activityRes.status);

        const statusData = await statusRes.json();
        const activityData = await activityRes.json();

        // Status
        const online = statusData.network?.online;
        const processState = statusData.process?.state || "unknown";
        const players = statusData.network?.players;
        const version = statusData.network?.version;
        const latency = statusData.network?.latency_ms;

        const dot = document.getElementById("mc-online-dot");
        const text = document.getElementById("mc-online-text");
        
        if (online) {
          dot.classList.add("online");
          text.textContent = "Online";
        } else {
          dot.classList.remove("online");
          text.textContent = "Offline";
        }

        document.getElementById("mc-process-state").textContent = processState;

        if (players) {
          const names = players.sample_names && players.sample_names.length
            ? ` [${players.sample_names.join(", ")}]`
            : "";
          document.getElementById("mc-players").textContent =
            `${players.online}/${players.max}${names}`;
        } else {
          document.getElementById("mc-players").textContent = "–";
        }

        document.getElementById("mc-version").textContent = version || "–";
        document.getElementById("mc-latency").textContent =
          latency != null ? latency.toFixed(1) + " ms" : "–";

        // Activity
        const moodBadge = document.getElementById("mc-mood-badge");
        const cpuPercent = activityData.cpu_percent || 0;
        const ram = activityData.ram;

        moodBadge.textContent = activityData.mood || "unknown";
        moodBadge.className = "badge";
        if (activityData.mood === "chill") moodBadge.classList.add("ok");
        else if (activityData.mood === "normal") moodBadge.classList.add("warn");
        else if (activityData.mood === "busy") moodBadge.classList.add("crit");
        else if (activityData.mood === "offline") {
          moodBadge.classList.add("offline");
        }

        document.getElementById("mc-cpu").textContent = cpuPercent.toFixed(1) + " %";
        setBar("mc-cpu-bar", cpuPercent);

        if (ram) {
          document.getElementById("mc-ram").textContent =
            `${formatGB(ram.used_gb)} / ${formatGB(ram.total_gb)} (${ram.percent.toFixed(1)}%)`;
          setBar("mc-ram-bar", ram.percent || 0);
        } else {
          document.getElementById("mc-ram").textContent = "–";
          setBar("mc-ram-bar", 0);
        }
      } catch (e) {
        console.error("Error fetching Minecraft info", e);
      }
    }

    async function callMinecraftAction(action) {
      const statusEl = document.getElementById("mc-action-status");
      statusEl.textContent = `Calling ${action}...`;

      const btnStart = document.getElementById("btn-start");
      const btnStop = document.getElementById("btn-stop");
      const btnRestart = document.getElementById("btn-restart");
      btnStart.disabled = btnStop.disabled = btnRestart.disabled = true;

      try {
        const res = await fetch(`/api/minecraft/${action}`, { method: "POST" });
        const data = await res.json().catch(() => ({}));

        if (res.ok && data.ok !== false) {
          statusEl.textContent = `Action '${action}' sent successfully.`;
        } else {
          statusEl.textContent = `Action '${action}' failed: ${data.stderr || "unknown error"}`;
        }
      } catch (e) {
        console.error(e);
        statusEl.textContent = `Action '${action}' failed: ${e.message}`;
      } finally {
        btnStart.disabled = btnStop.disabled = btnRestart.disabled = false;
        setTimeout(() => {
          refreshMinecraft();
        }, 1500);
      }
    }

    async function refreshMinecraftLogs() {
      const box = document.getElementById("mc-logs");
      const card = document.getElementById("mc-logs-card");
      if (!box || !card) return;

      try {
        const res = await fetch(mcLogsUrl);
        if (!res.ok) throw new Error("HTTP " + res.status);
      
        const data = await res.json();
      
        if (data.ok) {
          box.textContent = data.lines || "";
          // auto-scroll to bottom
          card.scrollTop = card.scrollHeight;
        } else {
          box.textContent = "Log error: " + (data.error || "unknown");
        }
      } catch (e) {
        console.error("Error fetching logs", e);
        box.textContent = "Failed to load logs: " + e.message;
      }
    }

    function initActions() {
      document.getElementById("btn-start").addEventListener("click", () => {
        callMinecraftAction("start");
      });
      document.getElementById("btn-stop").addEventListener("click", () => {
        callMinecraftAction("stop");
      });
      document.getElementById("btn-restart").addEventListener("click", () => {
        callMinecraftAction("restart");
      });
    }

    function tick() {
      refreshSystem();
      refreshMinecraft();
      refreshMinecraftLogs();
    }

    window.addEventListener("load", () => {
      initActions();
      tick();
      setInterval(tick, 5000);
    });
  </script>
</body>
</html>